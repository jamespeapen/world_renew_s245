---
title: "BIHS Model Fitting"
subtitle: "STAT-245, Calvin University"
author: "Ivanna Rodriguez, Myungha Kim, James Eapen"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  pdf_document:
    fig_height: 2.2
    fig_width: 4
    toc: true
    toc_depth: 2
  html_document:
    fig_height: 2.2
    fig_width: 4
  word_document:
    fig_height: 2.2
    fig_width: 4
---

```{r, setup, include = FALSE}
# load packages that are going to be used
require(tidyverse)   # this loads mosaic, ggformula, etc. too
require(ggformula)
require(mosaic)

# to read excel files
require(readxl)
# for collinearity
require(GGally)
# for IC
require(MuMIn)
# for VIF
require(car)


# Some customization.  You can alter or delete as desired (if you know what you are doing).

theme_set(theme_bw(base_size=12))     # change theme for ggplot2/ggformula

knitr::opts_chunk$set(
  echo = TRUE,      # for homework, always show R code (this is the default)
  tidy = FALSE,     # display code as typed (rather than reformatted)
  size = "small",   # slightly smaller font for code
  message = FALSE, warning = FALSE) # don't print warnings or messages in compiled document. So you MUST check them in RStudio!
```


```{r, include = FALSE}
# reading in the data
bihs <- read_csv('bihs_final.csv')
bihs_original <- read_excel('../tidy_dataset/BIHS_household_2011_15.xlsx')
bihs <- bihs%>%mutate(house_owned = bihs_original$house_owned)
bihs_original$survey_year <- as.factor(bihs_original$survey_year)
```

```{r, include = FALSE}
# selecting the variables we're going to use for our model
bihs_original <- bihs_original%>% 
  select(
          fcs,
          survey_year,
          asset_qty_poultry,
          asset_qty_cattle,
          asset_qty_otherlivestock,
          asset_qty_sheepgoat,
          memb_total,
          memb_und15,
          memb_15_44,
          hhs_total,
          bio_bio_1,
          bio_bio_12,
          house_owned,
          asset_cartplough, 
          asset_telephone,
        ) %>%
  na.omit()
```



The following document outlines our process for fitting a model that would predict food security score with the BIHS dataset. 

We used the variable `fcs` as our response variable. This is the food consumption score in the BIHS dataset that is a similar measure to the food security scores used in the GAC Livelihoods regressions. For our predictors, we looked at the predictors from the GAC Livelihoods that were statistically significant, and tried to find similar predictors in the BIHS dataset, which was a difficult task. We determined that `house_owned` and all of the assets predictors would be good candidates. 

We thought that the best way to go about determining what predictors were significant was to fit a model with as many variables from BIHS as we could, in addition to those found significant in the GAC Likelihoods regressions.


# Exploratory plots

We selected a few categorical variables for the BIHS dataset to see if there might be a relationship between the response `fcs` and the predictors. The boxplots are shown below.

```{r}
# whether they owned/rented a house
gf_boxplot(data = bihs, fcs ~ house_owned)

# tech assets
gf_boxplot(data = bihs, fcs ~ asset_cartplough)
gf_boxplot(data = bihs, fcs ~ asset_tractor)
gf_boxplot(data = bihs, fcs ~ asset_motorbike)
gf_boxplot(data = bihs, fcs ~ asset_telephone)
gf_boxplot(data = bihs, fcs ~ asset_radio)
```

# Fitting the model

We encountered some problems while trying to fit all of our variables into a single model. The model below is one that worked the best for now. It includes our variables of interest: `asset_cartplough` and `house_owned`.

```{r}
asset_lm <- lm(data = bihs_original, fcs ~ factor(survey_year) + asset_qty_poultry +
                 asset_qty_cattle + asset_qty_otherlivestock + asset_qty_sheepgoat + 
                 memb_total + memb_und15 + memb_15_44 + hhs_total + bio_bio_1 + 
                 bio_bio_12 + house_owned + asset_cartplough + asset_telephone, na.action = 'na.fail')

summary(asset_lm)
```

# Checking for multicollinearity between predictors

```{r fig.height= 5, fig.width=7}
# checking for collinearity in quantitative predictors
vif(asset_lm)

predictors <- bihs_original %>% select(
                              survey_year,
                              asset_qty_poultry,
                              asset_qty_cattle,
                              asset_qty_otherlivestock,
                              asset_qty_sheepgoat,
                              memb_total,
                              memb_und15,
                              memb_15_44,
                              hhs_total,
                              bio_bio_1,
                              bio_bio_12
                              )
ggpairs(predictors)
ggcorr(predictors)
```




# Removing predictors with high correlation

Because we found correlations between some of the predictors, we decided to remove them and create a new model. The following model is the one we decided to use for this analysis.

```{r}
asset_lm_two <- lm(data = bihs_original, fcs ~ factor(survey_year) + asset_qty_poultry +
                     asset_qty_cattle + asset_qty_otherlivestock + asset_qty_sheepgoat + 
                     memb_15_44 + hhs_total + bio_bio_12 + house_owned + asset_cartplough +
                     asset_telephone, na.action = 'na.fail')

summary(asset_lm_two)
vif(asset_lm_two)
```

# Model assessment 

```{r fig.height=3, fig.width= 7}
# linearity and constant variance
bihs_original <- bihs_original %>%
  mutate(res = resid(asset_lm_two),
         fitted = predict(asset_lm_two))
gf_point(res ~ fitted, data = bihs_original) %>%
  gf_labs(x = 'Fitted Values', y = 'Residuals')

# independence of residuals
acf(resid(asset_lm_two), main = '')

#normality of residuals
gf_histogram(~res, data = bihs_original, bins = 15) # they look a bit right skewed...
```

All the conditions for a linear regression seem to be met by our model, no major problems with linearity, constant variance, independence of residuals or normality of residuals can be seen.


# Model selection

We are demonstrating which predictors are the best at explaining the response variable in two ways: by using the `dredge` method, and the `Anova` method. The results are shown below.

```{r}
AIC_results <- dredge(asset_lm_two, rank = 'AIC')
head(AIC_results, 7)

BIC_results <- dredge(asset_lm_two, rank = 'BIC')
head(BIC_results, 7)
```

AIC reports that cartplough, cattle, telephone, precipitation and household total are important predictors of food consumption score.

BIC reports that cattle, telephone and household total are important predictors of food consumption scores.

It is imporant to note that the IC scores above are really close to each other, so we chose the models that had the least number of predictors to make a decision on which was the best model, but this is subjective.


# Analysis of Variance

```{r}
Anova(asset_lm_two)
```

ANOVA reports that cattle, household total, precipitation, cartplough, and telephone were significant at different significance levels which are outlined in the output above.

